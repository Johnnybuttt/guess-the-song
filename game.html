<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Guess The Song</title>
  <link rel="stylesheet" href="app.css">
</head>
<body>
<div class="container">
  <h1>Guess The Song</h1>

  <div class="card">
    <div class="kpi">
      <div><b>Round</b><div id="roundLabel" class="small">0 / 0</div></div>
      <div><b>Time left</b><div id="timer" class="small">—</div></div>
      <div><b>Score</b><div id="score" class="small">0</div></div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <button id="loginBtn" class="secondary">Login Spotify</button>
      <button id="initBtn" disabled>Initialize Player</button>
      <button id="playBtn" disabled>Play Round</button>
      <button id="skipBtn" class="secondary" disabled>Skip</button>
      <button id="quitBtn" class="secondary">Change Settings</button>
    </div>

    <div class="hr"></div>

    <p class="small" id="status">—</p>

    <div class="row">
      <input id="guess" placeholder="Type the song title while it plays…" disabled>
      <button id="submit" disabled>Submit</button>
    </div>

    <p id="result" style="margin-top:10px;"></p>
  </div>
</div>

<!-- 1) Define global callback BEFORE loading SDK -->
<script>
  window.__sdkReady = false;

  window.onSpotifyWebPlaybackSDKReady = () => {
    window.__sdkReady = true;
    document.getElementById("initBtn").disabled = false;
    document.getElementById("status").textContent =
      "Spotify SDK loaded. Click Initialize Player.";
  };
</script>

<!-- 2) Load SDK -->
<script src="https://sdk.scdn.co/spotify-player.js"></script>

<!-- 3) Game logic -->
<script type="module">
  import { beginLogin, isAuthed, getAccessToken, spotifyFetch } from "./spotify.js";

  // --- Settings from earlier pages (defaults if missing) ---
  const roundsTotal = Number(localStorage.getItem("rounds") || 10);
  const clipSeconds = Number(localStorage.getItem("clip") || 30);

  // OPTIONAL playlist value (if you later add it back on the rounds page)
  // If you didn't set it yet, it will be "" and we use a fallback.
  const playlistInput = localStorage.getItem("game_playlist") || "";

  // Fallback playlist (Today’s Top Hits)
  const FALLBACK_PLAYLIST_ID = "37i9dQZF1DXcBWIGoYBM5M";

  function parsePlaylistId(input) {
    const s = (input || "").trim();
    if (!s) return "";
    const m = s.match(/playlist\/([a-zA-Z0-9]+)/);
    return m ? m[1] : s; // if user pasted an ID, return it directly
  }

  const PLAYLIST_ID = parsePlaylistId(playlistInput) || FALLBACK_PLAYLIST_ID;

  // --- UI elements ---
  const loginBtn = document.getElementById("loginBtn");
  const initBtn = document.getElementById("initBtn");
  const playBtn = document.getElementById("playBtn");
  const skipBtn = document.getElementById("skipBtn");
  const quitBtn = document.getElementById("quitBtn");
  const statusEl = document.getElementById("status");
  const roundLabel = document.getElementById("roundLabel");
  const timerEl = document.getElementById("timer");
  const scoreEl = document.getElementById("score");
  const guessEl = document.getElementById("guess");
  const submitBtn = document.getElementById("submit");
  const resultEl = document.getElementById("result");

  // --- Game state ---
  let player = null;
  let deviceId = null;
  let tracks = [];
  let current = null;
  let round = 0;
  let score = 0;
  let roundActive = false;
  let countdown = null;
  let remainingMs = 0;

  function setStatus(t) { statusEl.textContent = t; }
  function setResult(t) { resultEl.textContent = t; }

  function normalizeTitle(s) {
    return (s || "")
      .toLowerCase()
      .replace(/\(.*?\)/g, "")
      .replace(/\[.*?\]/g, "")
      .replace(/feat\.|ft\./g, "")
      .replace(/[^a-z0-9\s]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  function updateUI() {
    roundLabel.textContent = `${round} / ${roundsTotal}`;
    scoreEl.textContent = String(score);

    loginBtn.disabled = isAuthed();
    loginBtn.textContent = isAuthed() ? "Logged in" : "Login Spotify";

    initBtn.disabled = !window.__sdkReady || !isAuthed() || !!deviceId;
    playBtn.disabled = !deviceId || tracks.length === 0 || roundActive || round >= roundsTotal;
    skipBtn.disabled = !roundActive;

    guessEl.disabled = !roundActive;
    submitBtn.disabled = !roundActive;
  }

  // --- Spotify Web API helpers ---
  async function transferPlayback() {
    // PUT /v1/me/player
    await spotifyFetch("/me/player", {
      method: "PUT",
      body: { device_ids: [deviceId], play: false }
    });
  }

  async function loadPlaylistTracks(playlistId) {
    // GET /v1/playlists/{id}/tracks
    let url = `/playlists/${playlistId}/tracks?limit=100`;
    const out = [];

    while (url) {
      const data = await spotifyFetch(url);
      for (const item of data.items || []) {
        const t = item.track;
        if (!t || !t.uri || !t.duration_ms) continue;

        out.push({
          id: t.id,
          uri: t.uri,
          name: t.name,
          duration_ms: t.duration_ms,
          artist: (t.artists && t.artists[0] && t.artists[0].name) ? t.artists[0].name : "Unknown"
        });
      }
      url = data.next ? data.next.replace("https://api.spotify.com/v1", "") : null;
    }

    return out;
  }

  async function pausePlayback() {
    try {
      await spotifyFetch(`/me/player/pause?device_id=${deviceId}`, { method: "PUT" });
    } catch {}
  }

  function pickRandomTrack() {
    return tracks[Math.floor(Math.random() * tracks.length)];
  }

  function stopCountdown() {
    if (countdown) clearInterval(countdown);
    countdown = null;
  }

  function startCountdown(ms) {
    remainingMs = ms;
    timerEl.textContent = `${Math.ceil(ms / 1000)}s`;

    stopCountdown();
    countdown = setInterval(async () => {
      remainingMs -= 200;
      timerEl.textContent = `${Math.max(0, Math.ceil(remainingMs / 1000))}s`;
      if (remainingMs <= 0) {
        stopCountdown();
        await pausePlayback();
        roundActive = false;
        setResult(`Time! It was "${current.name}" — ${current.artist}`);
        updateUI();
      }
    }, 200);
  }

  async function playClip(track) {
    const clipMs = clipSeconds * 1000;
    const maxStart = Math.max(0, track.duration_ms - clipMs);
    const startMs = Math.floor(Math.random() * (maxStart + 1));

    // Start playback
    await spotifyFetch(`/me/player/play?device_id=${deviceId}`, {
      method: "PUT",
      body: { uris: [track.uri] }
    });

    // Seek into the track
    await spotifyFetch(`/me/player/seek?position_ms=${startMs}&device_id=${deviceId}`, {
      method: "PUT"
    });

    startCountdown(clipMs);
  }

  async function startRound() {
    setResult("");
    guessEl.value = "";

    round += 1;
    current = pickRandomTrack();
    roundActive = true;
    updateUI();

    await playClip(current);
  }

  async function endRoundCorrect() {
    stopCountdown();
    await pausePlayback();
    roundActive = false;
    score += 1;
    setResult(`✅ Correct! "${current.name}" — ${current.artist}`);
    updateUI();
  }

  async function skipRound() {
    stopCountdown();
    await pausePlayback();
    roundActive = false;
    setResult(`Skipped. It was "${current.name}" — ${current.artist}`);
    updateUI();
  }

  // --- Button handlers ---
  loginBtn.onclick = () => beginLogin();
  quitBtn.onclick = () => window.location.href = "index.html";

  initBtn.onclick = async () => {
    try {
      if (!isAuthed()) {
        setStatus("Log in first.");
        return;
      }
      if (!window.Spotify) {
        setStatus("Spotify SDK not ready yet. Refresh and try again.");
        return;
      }

      setStatus("Creating browser player…");

      player = new window.Spotify.Player({
        name: "Guess The Song (Browser Player)",
        getOAuthToken: cb => cb(getAccessToken()),
        volume: 0.8
      });

      player.addListener("ready", async ({ device_id }) => {
        deviceId = device_id;
        setStatus(`Player ready. Device ID: ${deviceId}`);

        // IMPORTANT: split these so we know what is 404ing
        try {
          setStatus("Transferring playback to browser device…");
          await transferPlayback();
          setStatus("Playback transferred. Loading tracks…");
        } catch (e) {
          setStatus("Transfer playback failed: " + (e?.message || e));
          console.error(e);
          updateUI();
          return;
        }

        try {
          tracks = await loadPlaylistTracks(PLAYLIST_ID);
          setStatus(`Ready. Loaded ${tracks.length} songs. (${roundsTotal} rounds, ${clipSeconds}s clips)`);
        } catch (e) {
          setStatus("Load tracks failed: " + (e?.message || e) + " | playlist id: " + PLAYLIST_ID);
          console.error(e);
        }

        updateUI();
      });

      player.addListener("authentication_error", ({ message }) => setStatus("Auth error: " + message));
      player.addListener("account_error", ({ message }) => setStatus("Account error: " + message));
      player.addListener("initialization_error", ({ message }) => setStatus("Init error: " + message));
      player.addListener("not_ready", () => setStatus("Player went offline. Refresh."));

      await player.connect();
      setStatus("Connecting…");
    } catch (e) {
      setStatus("Error: " + (e?.message || e));
      console.error(e);
    }
  };

  playBtn.onclick = async () => {
    try {
      await startRound();
    } catch (e) {
      round -= 1;
      roundActive = false;
      setStatus("Could not play: " + (e?.message || e));
      console.error(e);
      updateUI();
    }
  };

  skipBtn.onclick = () => skipRound();

  submitBtn.onclick = async () => {
    const g = normalizeTitle(guessEl.value);
    if (!g) return;

    const a = normalizeTitle(current?.name);
    if (g === a) {
      await endRoundCorrect();
    } else {
      setResult("Not quite — keep guessing while it plays.");
    }
  };

  guessEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") submitBtn.click();
  });

  // --- Initial UI state ---
  setStatus(isAuthed()
    ? "Logged in. Load the Spotify SDK then Initialize Player."
    : "Not logged in yet."
  );
  updateUI();
</script>
</body>
</html>
